name: Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: chmod +x gradlew

      # 1. Build Android (H "κόρη οφθαλμού")
      - name: Build Android
        run: ./gradlew :composeApp:assembleDebug

      # 2. Build iOS Simulator App
      - name: Build iOS for Simulator
        run: |
          # Χτίζουμε το framework
          ./gradlew :composeApp:iosSimulatorArm64Binaries
          
          # Χτίζουμε το .app μέσω xcodebuild
          xcodebuild -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Debug \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build/derivedData \
            ONLY_ACTIVE_ARCH=NO \
            build
          
          # Εντοπισμός και συμπίεση του .app για το Appetize
          APP_PATH=$(find build/derivedData -name "*.app" | head -n 1)
          APP_DIR=$(dirname "$APP_PATH")
          APP_NAME=$(basename "$APP_PATH")
          cd "$APP_DIR"
          zip -r ios-app-sim.zip "$APP_NAME"
          cp ios-app-sim.zip $GITHUB_WORKSPACE/

      # 3. Ανέβασμα Android APK
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: composeApp/build/outputs/apk/debug/composeApp-debug.apk

      # 4. Ανέβασμα iOS ZIP (για Appetize.io)
      - name: Upload iOS Zip for Appetize
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-zip
          path: ios-app-sim.zip